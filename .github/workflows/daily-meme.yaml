name: Generate Daily Meme

on:
  schedule:
    # Körs kl 08:00 varje dag (UTC)
    - cron: '0 8 * * *'
  # Gör så att du kan köra den manuellt för att testa
  workflow_dispatch:

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Generate Image with AI (Python script)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          pip install openai requests
          
          cat <<EOF > generate_meme.py
          from openai import OpenAI
          import requests
          import os
          import random
          from datetime import datetime

          client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

          # --- KARAKTÄRER ---
          char_data = {
              "Jeff": "a bald man with a dark well-groomed beard, broad shoulders, and a black necklace",
              "Ragge": "a skinny man with an undercut hairstyle (shaved sides, dark hair on top), sunglasses resting on top of his head, wearing a white t-shirt",
              "Marco": "a man with short brown hair slicked back, a short stubble beard, and a friendly smile"
          }
          names = list(char_data.keys())

          # --- SLUMPA ---
          count = random.randint(1, 3)
          selected_names = random.sample(names, count)
          chars_description = ", ".join([f"{name} ({char_data[name]})" for name in selected_names])
          names_text = " and ".join(selected_names)
          
          # --- AKTIVITETER ---
          activities = [
              "debugging code in a jungle",
              "having a coffee break on the moon",
              "running away from a giant bug",
              "celebrating a successful deploy",
              "stuck in an infinite loop"
          ]
          activity = random.choice(activities)

          # --- PROMPT ---
          prompt_text = (
              f"A funny digital art meme of {names_text}. "
              f"Appearance: {chars_description}. "
              f"They are {activity}. "
              "Colorful, expressive style."
          )
          
          print(f"Generating for: {names_text}")

          response = client.images.generate(
            model="dall-e-3",
            prompt=prompt_text,
            size="1024x1024",
            quality="standard",
            n=1,
          )

          image_url = response.data[0].url
          
          # 1. Spara med dagens datum (för historik)
          date_str = datetime.now().strftime("%Y-%m-%d")
          filename_date = f"meme-{date_str}.png"
          
          img_data = requests.get(image_url).content
          
          with open(filename_date, 'wb') as f:
              f.write(img_data)
              
          # 2. Spara som daily-meme.png (för startsidan)
          with open('daily-meme.png', 'wb') as f:
              f.write(img_data)

          print(f"Saved {filename_date} and daily-meme.png")
          EOF
          
          python generate_meme.py

      - name: Upload to S3
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --acl public-read
        env:
          AWS_S3_BUCKET: 'chobacka-meme-bucket' # DIN BUCKET HÄR
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'eu-north-1'
          SOURCE_DIR: '.' 
          DEST_DIR: '' 
          # Ladda upp både dagens och den tidsstämplade
          Include: '*.png'